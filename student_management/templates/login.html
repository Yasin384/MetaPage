from django.shortcuts import render, redirect
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.decorators import login_required
from .models import User, Attendance, Course
from django.utils import timezone
from geopy.distance import geodesic

def login_view(request):
    if request.method == 'POST':
        email = request.POST['email']
        password = request.POST['password']
        user = authenticate(request, username=email, password=password)
        if user is not None:
            login(request, user)
            return redirect('dashboard')
    return render(request, 'login.html')

@login_required
def dashboard(request):
    return render(request, 'dashboard.html')

@login_required
def check_attendance(request):
    user = request.user
    college_coords = (42.85756076410975, 74.59857798966878)
    user_coords = (request.POST.get('latitude'), request.POST.get('longitude'))
    
    distance = geodesic(college_coords, user_coords).meters
    
    if distance <= 150:
        Attendance.objects.create(user=user, date=timezone.now().date(), attended=True)
        user.points += 1
        user.save()
        return JsonResponse({'status': 'success', 'message': 'Attendance marked'})
    else:
        return JsonResponse({'status': 'error', 'message': 'You are not in the college area'})

@login_required
def leaderboard(request):
    users = User.objects.order_by('-points')
    return render(request, 'leaderboard.html', {'users': users})